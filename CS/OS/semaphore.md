# 세마포어 (Semaphore)

멀티 프로그래밍을 할 때 프로세스끼리 공유하는 자원에 대해 접근을 제어해주는 정수형 변수이다.

멀티프로그래밍 환경에서 여러 개의 프로세스가 실행될 때, 자원을 분배하는 과정에서 각 프로세스마다 의미를 가지는 처리 단위만큼의 자원 분배를 보장해주지 못하기 때문에 세마포어가 필요하다.

즉, 프로세스가 어떤 공유자원에 대해 의도한 행동을 끝내기 전 까지 다른 프로세스에게 해당 자원에 대한 접근권한을 주지 않도록 해서 임계영역을 보호해 주기 위함이다.



## 예시

정수형 공유 자원 `a` (초기값 0) 에 대해서 번갈아 작동하는 두 프로세스가 있다.

`a`를 두 번 증가시키고 값을 읽는 프로세스 A와 `a`를 두 번 감소시키고 값을 읽는 프로세스 B가 있다고 하자.

이 때 각 프로세스가 의도한 행동은 다음의 순서로 이루어진다.

|               A               |               B               |
| :---------------------------: | :---------------------------: |
| `a`의 값을 증가 (`a = a + 1`) | `a`의 값을 감소 (`a = a - 1`) |
| `a`의 값을 증가 (`a = a + 1`) | `a`의 값을 감소 (`a = a - 1`) |
|    `a`를 읽음 (`return a`)    |    `a`를 읽음 (`return a`)    |
|          기댓값 : 2           |          기댓값 : 0           |

하지만 세마포어를 사용하지 않으면 컴퓨터가 작동하는 과정에서 각 프로세스의 두 연산이 끝나기 전에 context switching이 발생할 수 있다. 그 경우 아래와 같은 오류가 발생할 것이다.



`a` : 0

**A**

`a = a + 1`

`a = a + 1`

`return a` ( 기댓값 : 2, 반환값 : 2 )

*context switching*

**B**

`a = a - 1`

`a = a - 1`

`return a` ( 기댓값 : 0, 반환값 : 0)

**A**

`a = a + 1`

*context switching*

**B**

`a = a - 1`

`a = a - 1`

`return a` ( 기댓값 : 0, 반환값 : -1)	// **문제발생**

*context switching*

**A**

`a = a + 1`

`return a` ( 기댓값 : 2, 반환값 : 1)	// **문제발생**



이 경우 이진세마포어를 사용해 임계영역을 보호해준다면

|                         A                         |                         B                         |
| :-----------------------------------------------: | :-----------------------------------------------: |
| `semaphore`가 1이면 1 감소시키고 수행, 0이면 대기 | `semaphore`가 1이면 1 감소시키고 수행, 0이면 대기 |
|           `a`의 값을 증가 (`a = a + 1`)           |           `a`의 값을 감소 (`a = a - 1`)           |
|           `a`의 값을 증가 (`a = a + 1`)           |           `a`의 값을 감소 (`a = a - 1`)           |
|                 `semaphore` 증가                  |                 `semaphore` 증가                  |
|             `a`를 읽음 (`return a`)`              |             `a`를 읽음 (`return a`)`              |
|                    기댓값 : 2                     |                    기댓값 : 0                     |

> counting 방식의 semaphore를 이해하기 쉽게 ++, -- 를 사용한 증/감으로 표현했지만 semaphore에 접근하는 과정 자체에서 countext switching 되면 안되기 때문에 hardware로 값을정하는 atomic한 함수를 이용해야 한다.

위와 같은 상황에서 아래처럼 처리될 것이다.



`a` : 0

`semaphore` : 1

**A**

`semaphore--`

`a = a + 1`

`a = a + 1`

`semaphore++`

`return a` ( 기댓값 : 2, 반환값 : 2 )

*context switching*

**B**

`semaphore--`

`a = a - 1`

`a = a - 1`

`semaphore++`

`return a` ( 기댓값 : 0, 반환값 : 0)

**A**

`semaphore--`

`a = a + 1`

*context switching*

**B**

*(수행하지 않음)*

*context switching*

**A**

`a = a + 1`

`semaphore++`

`return a` (기댓값 : 2, 반환값 : 2)

*context switcing*

**B**

`semaphore--`

`a = a - 1`

`a = a - 1`

`semaphore++`

`return a` ( 기댓값 : 0, 반환값 : 0)



## mutex

뮤텍스는 세마포어의 정수값 감소, 증가 처럼  `lock`, `unlock` 연산을 통해 상호 배제(Mutual Exclusion)를 보장해 주는 값이다. 이진 세마포어인 경우 뮤텍스처럼 동작한다.



### 차이점

일반적으로는 뮤텍스는 프로세스 내에서 공유되어 `lock`과 `unlock`을 한 프로세스가 할 수 있는 구조이고 세마포어는 서로 다른 프로세스도 접근가능한 차이점이 있다.

